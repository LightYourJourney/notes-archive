# 树莓派的舵机控制

1. <a name="_page57_x72.00_y589.84"></a>舵机简介

电机也称作马达，是电子设备中常用的动力原件。电机从使用用途上可以分为驱动电机和控制电机， 其中驱动电机常通过持续的旋转为设备提供动力，例如电转、电动车、洗衣机等电子产品的动力大多由驱 动电机提供。控制电机主要分为步进电机和伺服电机。步进电机是一种将电脉冲转化为角位移的执行机 构，可以驱动电路控制转向固定的角度，经常用于精密控制，例如数控机床、硬盘驱动器等。伺服电机的可 以通过电压控制电机的转速或力矩，要求电机的反应要快，经常用于各种运动控制系统中。

舵机是一种通过电信号控制转动角度的设备，可以看作是简单的伺服电机，由于经常应用于航模的舵 面控制，因而被称为舵机。虽然和步进电机都是用来控制转动角度，但步进电机多用于负载不大，精度要求 高的场合，而舵机往往需要输出较大的力矩，用于大负载的场景。

2. 树莓派的舵机控制 53

![](Aspose.Words.b353301d-f3c7-44fc-a0ef-0183eb531768.088.jpeg)

<a name="_page58_x72.00_y64.23"></a>图 6.1: SG90 舵机

图 [6.1](#_page58_x72.00_y64.23) 是一种比较常用的 9g 舵机（由于重量只有 9 克，所以一般称为 9 克舵机），它的主要指标如下：

- 工作电压：直流 4.8V 到 6V
- 工作电流： 80mA 到 100mA
- 待机电流： 5mA
- 扭力：1.3 到 1.7kg/cm
- 转速：0.09 到 0.10 秒每 60 度（ 4.8V）
- 信号周期： 20 毫秒

舵机的连接线为三根，其中红色线为电源，棕色线为地线，黄色线为信号线。信号线的数据格式为

PWM，这与第 [2.3.3 ](#_page23_x72.00_y589.05)节中介绍的信号格式一致，只不过这里并不是用来输出功率，而是通过舵机内部的控

制逻辑，将 PWM 信号转换为角度。由于 PWM 信号比较简单，很多处理器都有硬件的 PWM 控制器，可 以通过一个 GPIO 管脚实现对舵机的控制。

控制舵机时， PWM 信号的周期为 20ms，当高电平时间为 0.5ms 时舵机输出的角度为 0 度，当高电平 时间为 2.5 ms 时输出角度为 180 度（对于 90 度舵机则输出 90 度），占空比与输出角度为线性关系，通过 计算可以得到占空比与角度的关系，下面示例程序展示了舵机在树莓派上测试的代码。

import RPi.GPIO as GPIO

from time import sleep

GPIO.setmode(GPIO.BCM)

GPIO.setup(12, GPIO.OUT) # 使用 12 号管脚来控制舵机 pwm = GPIO.PWM(12,50)

pwm.start(0)

pwm.ChangeDutyCycle(2.5) # 输出 0 度

sleep(1)

pwm.ChangeDutyCycle(7.5) # 输出 90 度

sleep(1)

pwm.stop()

GPIO.cleanup()

2. 多舵机联合控制

对于机械臂、机器人等应用，舵机的数目一般较多，需要的电流比较大，无法通过树莓派进行供电，此 时一般选择使用专门的舵机驱动电路来驱动和控制舵机。一种常用的多舵机控制模块基于 PCA9685 芯 片，可以同时支持 16 路舵机的控制。图 [6.2](#_page59_x72.00_y64.23) 为该模块的外形。

PCA9685 模块的 V+接口可以用来接入外部电源驱动舵机， SDA, SCL是树莓派的 I^2C 接口。支持 PCA9685 模块的开源代码很多，下面的示例使用 adafruit\_servokit 来控制接入的最多 16 路舵机。

from time import sleep

from adafruit\_servokit import ServoKit

kit = ServoKit(channels=16)

54 第六章 构建专家系统

![](Aspose.Words.b353301d-f3c7-44fc-a0ef-0183eb531768.089.jpeg)

<a name="_page59_x72.00_y64.23"></a>图 6.2: 16 路舵机驱动控制版

kit.servo[0].angle = 175 sleep(1) kit.servo[0].angle = 45 sleep(1)

3. I2C 总线传输原理

I2C 总线最初由 Philips Semiconductor（ NXP Semiconductors）提出，用于处理微处理器与芯片之间 的串行低速数据交互。相比于 SPI 连接信号更少，不需要额外的地址译码器及片选信号，多个器件可以简 单的连接到同一条 I2C 总线，在与传感器、低速 AD/DA、低速 OLED 显示屏等低速数据交互方面获得了 较为广泛的使用。 SMBus（ System Management Bus）是 I2C 的一个子集，最早在 1995 年由 Intel 公司定 义，最广泛的应用在电脑主板及外部电源模块、温度传感器、电压传感器等数据交互。典型的 I2C 应用如 图 [6.3](#_page60_x72.00_y64.23)所示。

一般的，使用 I2C 设备连接中由主（ master）、从（ slave）设备组成。主设备发起 /结束一次传输，并维护 时钟信号，从设备根据主设备的寻址来响应数据传输。在同一时刻允许一个设备发送数据至总线，其余设

备接收总线的信号。 I2C 总线由两根线 SDA 及 SCL 两根线连接主从设备，两根线都采用上拉方式连接到

VDD。

I2C 支持多种模式下速率传输，分别是标准模式、快速模式、快速模式 +、高速模式。传输速率从 100kbit/s（标准模式）至 3.4Mbit/s（高速模式）。一次典型的数据传输过程如图 [6.4](#_page60_x72.00_y351.25)所示。

I2C 数据传输由主设备产生一个起始位开始，然后传递 7 个地址位（对于 7 位地址模式），指定通信的 从设备。接下来传递的一位是读写位， 0 表示写入， 1 表示读出。再接下来的一位由从设备驱动，如果从设 备的地址与主设备发出的地址相同，从设备将把 SDA 信号拉低，表示确认这次数据传输（ ACK）。当从设 备地址被确认，真正的数据传输就开始了。如果是写入数据，则数据线仍由主设备驱动，从设备在每个字节

传输之后也要驱动一位的 ACK 信号。如果是读出数据，则数据线由从设备驱动，主设备仅在应答时输出

ACK 位。最后由主设备产生一个停止位表示数据传输结束。所有的 I2C 数据与地址，都是先传递最高位， 最后传递最低位。

4. 扩展板上的 I2C 设备

在扩展板上连接了多个 I2C 设备，有 DS3231、BMP280 和 PCF8574。

DS3231 是一款高度集成的 RTC（ Real Time Clock）时钟芯片，自动维护时分秒、年月日时间信息。其

2. 树莓派的舵机控制 55

![](Aspose.Words.b353301d-f3c7-44fc-a0ef-0183eb531768.090.jpeg)

<a name="_page60_x72.00_y64.23"></a>图 6.3: 典型 I2C 应用

![](Aspose.Words.b353301d-f3c7-44fc-a0ef-0183eb531768.091.png)

<a name="_page60_x72.00_y351.25"></a>图 6.4: I2C 数据传输过程

内部框图如图 [6.5](#_page61_x72.00_y64.23)所示，内部寄存器如图 [6.6](#_page62_x72.00_y64.23)所示。

PCF8574 是基于 I2C 接口的 8bit IO 接口扩展芯片，通过其接收方向杆的输入及控制蜂鸣器的输出， 其内部框图如图 [6.7](#_page62_x72.00_y355.92)所示，外设连接如图 [6.8](#_page63_x72.00_y64.23) 所示。从图 [6.8](#_page63_x72.00_y64.23) 中可以看出：五方向摇杆按钮的四个方向接到了

PCF8574 的 P0 到 P3 端口（分别对应 “左 ”、“上 ”、“下 ”、“右 ” 四个方向）， P4 端口接了发光管 LED2，P7 端口接了蜂鸣器输出。

5. I2C 设备访问

2. 树莓派的舵机控制 55

在树莓派中开发环境中已经安装了安装 smbus 库和 i2c-tools 莓派 I2C 设备的扫描，如下所示：

pi@raspberrypi:~ $ sudo i2cdetect -y 1

0  1 2 3 4 5 6 7 8 9 a b c d e f

00: -- -- -- -- -- -- -- -- -- -- -- -- -- 10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 20: 20 -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --

40: -- -- -- -- -- -- -- -- 48 -- -- -- -- -- -- --

工具。 i2c-tools中 i2cdetect 完成树

56 第六章 构建专家系统

![](Aspose.Words.b353301d-f3c7-44fc-a0ef-0183eb531768.092.jpeg)

<a name="_page61_x72.00_y64.23"></a>图 6.5: DS3231 内部框图

50: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 60: -- -- -- -- -- -- -- -- 68 -- -- -- -- -- -- -- 70: -- -- -- -- -- -- 76 --

根据扫描的结果，树莓派共接入了四个 I2C 设备，其中地址 20 为 PCF8574 IO 扩展芯片（参考图 [6.7 ](#_page62_x72.00_y355.92)和图 [6.8](#_page63_x72.00_y64.23)，它连接了五方向按键的其中四个方向、 LED2 发光管和 BUZ 蜂鸣器）；地址 48 为 PCF8591 AD/DA 扩展芯片（参考图 [8.13](#_page81_x72.00_y64.23)）；地址 68 为 DS3231 实时钟芯片（参考图 [6.5](#_page61_x72.00_y64.23)）；地址 76 为 BMP280 芯片

（为气压传感器，本实验暂未使用）。

Smbus 完成了一些基本 I2C 函数的封装，可以使用 pydoc smbus 获取库帮助信息。常用的函数有：

1. read\_byte(address) 从地址 address 中读取数据
1. write\_byte(address, data) 向地址 address 中写入 data

下面的示例程序给出了五向摇杆输入的读取。 import smbus

address = 0x20

bus = smbus.SMBus(1) # 初始化 i2c Bus

- 关闭蜂鸣器、初始化准双向 IO 口为输入

2. 树莓派的舵机控制 57

![](Aspose.Words.b353301d-f3c7-44fc-a0ef-0183eb531768.093.jpeg)

<a name="_page62_x72.00_y64.23"></a>图 6.6: DS3231 内部寄存器

![](Aspose.Words.b353301d-f3c7-44fc-a0ef-0183eb531768.094.jpeg)

<a name="_page62_x72.00_y355.92"></a>图 6.7: PCF8574 内部框图

bus.write\_byte(address, 0xff)

- 摇杆输入

joystick\_val = bus.read\_byte(address)

RTC DS3231 的地址为 0x68，挂载在 i2cbus-1 上，下面示例给出了 RTC 的访问流程 import smbus

58 第六章 构建专家系统

![](Aspose.Words.b353301d-f3c7-44fc-a0ef-0183eb531768.095.jpeg)

<a name="_page63_x72.00_y64.23"></a>图 6.8: PCF8574 外设连接

import time # 包含相关库文件

address = 0x68

register = 0x00

bus = smbus.SMBus(1) # 初始化 i2c Bus

- FixTime 定义为 2019 年 6 月 12 日 18 时 FixTime = [0x00,0x00,0x18,0x03,0x12,0x06,0x19]
- 定义时钟操作函数

  def ds3231SetTime():

bus.write\_i2c\_block\_data(address,register,FixTime)

def ds3231ReadTime():

return bus.read\_i2c\_block\_data(address,register,7);

ds3231SetTime() # 设置时间 ds3231ReadTime() # 读出时间

write\_i2c\_block\_data 中的第一个参数是 I2C 的地址，第二个参数是传递给从设备的命令， DS3231 的 I2C 协议规定这个命令就是后续传递数据的起始地址。根据图 [6.6](#_page62_x72.00_y64.23) 中寄存器的描述。 ds3231SetTime 写入了前 7 个地址，分别设置了年月日时分秒和星期的内容。 ds3231ReadTime 读出前 7 个地址，也包含 了全部的时间信息。

注意这里 DS3231 中保存的数据都是 BCD 编码类型，也就是 0x19 代表十进制数 19，在操作和应用 的时候要注意转换。
