# 1-Wire 总线与传感器

## 1-Wire 总线简介

1-Wire 总线（单总线）是 Maxim 全资子公司 Dallas 的一项专有技术。与目前多数标准串行数据通信方式 SPI/I2C/MICROWIRE 不同，它采用单根信号线，既传输时钟又传输数据，而且数据传输是双向的。

1-Wire 总线接口具有节省 I/O 资源、结构简单、成本低廉、便于总线扩展和维护等诸多优点。

如图 3.1 所示，1-Wire 总线由一个总线主节点以及一个或多个从节点组成系统，主节点通过一根信号线对从节点进行数据的读取。1-Wire 总线的主节点一般是微控制器，从节点通常为单总线器件，例如温度传感器、身份识别器等。每一个符合 1-Wire 协议的从节点都有一个唯一的地址，包括 48 位的序列号、8 位 的家族代码和 8 位的 CRC 代码。主节点对各从节点的寻址依据这 64 位的不同来进行。

1-Wire 总线利用一根信号线实现双向通信。因此其协议对时序的要求较严格。基本的时序包括复位及应答时序、写一位时序、读一位时序。在复位及应答时序中，主器件发出复位信号后，要求从器件在规定的时间内送回应答信号；在位读和位写时序中，主器件要在规定的时间内读回或写出数据。1-Wire 总线适用于单个主机系统，能够控制一个或多个从机设备。主机可以是微控制器，从机可以是单总线器件，它们之间的数据交换只通过一条信号线。当只有一个从机位于总线上时，系统可按照单节点系统操作；而当多个从机位于总线上时，则系统按照多节点系统操作。

<figure markdown="span">
  ![alt text](../../../assets/images/ee/pi/.png){ width="300" }
  <figcaption>图 3.1: 1-Wire 总线系统组成</figcaption>
</figure>

1-Wire 总线被定义为仅有一根数据线，数据线连接一个 4.7K 欧姆的上拉电阻，电阻再接到电源 (3V 到 5.5V)。每个设备（主设备或从设备）通过一个漏极开路或 3 态门引脚连接至数据线上。这就允许每个 设备“释放”数据线，当设备没有传递数据的时其他设备可以有效地使用数据线。

## 温度传感器 DS18B20

DS18B20 数字温度传感器提供 9-Bit 到 12-Bit 的摄氏温度测量精度和一个用户可编程的非易失性 且具有过温和低温触发报警的报警功能。DS18B20 采用的 1-Wire 通信即仅采用一个数据线（以及地）与 微控制器进行通信。该传感器的温度检测范围为 -55°C 至 +125°C，并且在温度范围超过 -10°C 至 85°C 之 外时还具有 +-0.5°C 的精度。此外，DS18B20 可以直接由数据线供电而不需要外部电源供电。

每片 DS18B20 都有一个独一无二的 64 位序列号，所以一个 1-Wire 总线上可连接多个 DS18B20 设 备。因此，在一个分布式的大环境里用一个微控制器控制多个 DS18B20 是非常简单的。这些特征使得其 在环境控制、在建筑、设备及机械的温度监控系统、以及温度过程控制系统中有着很大的优势。DS18B20 的外观与引脚定义如图 3.2 所示，内部结构图 3.3 所示。

<figure markdown="span">
  ![alt text](../../../assets/images/ee/pi/.png){ width="300" }
  <figcaption>图 3.2: DS18B20 外观与引脚定义</figcaption>
</figure>

## 树莓派温度传感器 DS18B20 的基本使用

实验器材中的 Pioneer 600 扩展板利用树莓派 GPIO 接口扩展了 1-Wire 总线接口，可以方便的接入

各种 1-Wire 器件。实验中用到的温度传感器 DS18B20 通过 Pioneer 600 扩展板提供的 1-Wire 接口连接 到树莓派，参考图 2.2 中的 ONE-WIRE 接口的位置。

树莓派提供了 2 个驱动模块 w1-gpio 与 w1-therm，分别用于通过 GPIO 扩展 1-Wire 总线接口及提 供对温度传感器 DS18B20 的读写控制。其中，w1-gpio 提供了 1-Wire 总线的 I/O 操作方法，w1-therm 提供了对温度传感器 DS18B20 的内部操作方法。在通过 1-Wire 总线访问温度传感器之前需要确认系统已加载 w1-gpio 与 w1-therm 模块。在命令行输入 lsmod 命令，lsmod 命令用于显示已载入系统的模块。lsmod 命令的输出如包含 w1-gpio 与 w1-therm 模块则表示可以正常使用此接口。

<figure markdown="span">
  ![alt text](../../../assets/images/ee/pi/.png){ width="300" }
  <figcaption>图 3.3: DS18B20 内部结构</figcaption>
</figure>

如果通过 lsmod 命令发现 w1-gpio 与 w1-therm 模块尚未加载，可以通过 modprobe 命令加载这 2 个模块。加载方式如下：

```bash
pi@raspberrypi:~$ sudo modprobe w1-gpio
pi@raspberrypi:~$ sudo modprobe w1-therm
```

其中，sudo 是 linux 系统管理指令，允许系统管理员让普通用户执行一些或者全部的 root 权限命令。确认或完成 w1-gpio 与 w1-therm 模块的加载后，进入文件系统 /sys/bus/w1/devices 目录，并显示当前目录，操作方式和输出结果如下 :

```bash
pi@raspberrypi:~$ cd /sys/bus/w1/devices
pi@raspberrypi:~$ ls
28-00000674869d w1_bus_master1
```

执行 ls 命令后在 /sys/bus/w1/devices 目录下会发现一个以 28-XXXX 开头的文件夹（如果接多个 DS18B20，将会看到多个 28-xxxx 的文件，分别对应各个 DS18B20）。进入以 28-XXXX 开头的文件夹，显 示文件夹会发现一个名为 w1\_slave 的文件，利用 cat 命令读取文件 w1\_slave 的内容会返回温度传感器 当前的温度值。操作方式与输出结果如下：

```bash
pi@raspberrypi:~$ cd 28-00000674869d
pi@raspberrypi:~$ sudo cat w1_slave
70 01 4b 46 7f ff 10 10 e1 : crc=e1 YES
70 01 4b 46 7f ff 10 10 e1 t=23000
```

执行 cat w1_slave 命令输出 2 行结果，第一行显示了 CRC 校验结果，最后的 YES 表示 CRC 校验 成功，数据有效；第二行输出结果中的 t=23000 就是当前的温度值，换算成摄氏度需要除以 1000，即当前温度为 23000/1000=23 摄氏度。
